---
title: Индексы по вычисляемым столбцам | Документация Майкрософт
ms.custom: ''
ms.date: 11/19/2018
ms.prod: sql
ms.prod_service: table-view-index, sql-database
ms.reviewer: ''
ms.technology: table-view-index
ms.topic: conceptual
helpviewer_keywords:
- computed columns, index creation
- index creation [SQL Server], computed columns
- imprecise columns
- persisted computed columns
- precise [SQL Server]
ms.assetid: 8d17ac9c-f3af-4bbb-9cc1-5cf647e994c4
author: MikeRayMSFT
ms.author: mikeray
monikerRange: =azuresqldb-current||>=sql-server-2016||=sqlallproducts-allversions||>=sql-server-linux-2017||=azuresqldb-mi-current
ms.openlocfilehash: de2efcf3b99e21284cf964b1cd43bc85027ecaac
ms.sourcegitcommit: da88320c474c1c9124574f90d549c50ee3387b4c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/01/2020
ms.locfileid: "85760793"
---
# <a name="indexes-on-computed-columns"></a>Индексы вычисляемых столбцов
[!INCLUDE [SQL Server Azure SQL Database](../../includes/applies-to-version/sql-asdb.md)]

Индексы вычисляемых столбцов можно определить, если удовлетворяются следующие требования:  
  
-   требования к владению;  
-   требования к детерминированности;  
-   требования к точности;  
-   требования к типам данных;  
-   требования к параметру SET.  
  
#### <a name="ownership-requirements"></a>Требования к владению
  
Все ссылки на функции в вычисляемом столбце должны иметь того же владельца, что и таблица.  
  
## <a name="determinism-requirements"></a>Требования к детерминированности

Выражения являются детерминированными, если они всегда возвращают один и тот же результат для определенного набора входных данных. Свойство **IsDeterministic** функции [COLUMNPROPERTY](../../t-sql/functions/columnproperty-transact-sql.md) определяет, детерминировано ли выражение *computed_column_expression*.  
Выражение *computed_column_expression* должно быть детерминированным. Выражение *computed_column_expression* является детерминированным, если соблюдается хотя бы одно из следующих условий.  
  
-   Все функции, на которые ссылается выражение, являются детерминированными и точными. Это относится как к пользовательским, так и к встроенным функциям. Дополнительные сведения см. в разделе [Deterministic and Nondeterministic Functions](../../relational-databases/user-defined-functions/deterministic-and-nondeterministic-functions.md). Функции могут быть неточными, если вычисляемый столбец помечен как PERSISTED. Дополнительные сведения см. ниже в разделе [Создание индексов материализованных вычисляемых столбцов](#BKMK_persisted).  
  
-   Все столбцы, на которые ссылается выражение, берутся из таблицы, содержащей вычисляемый столбец.  
  
-   Ни одна ссылка на столбец не запрашивает данные из нескольких строк. Например, агрегатные функции, такие как SUM или AVG, используют данные из нескольких строк и делают выражение *computed_column_expression* недетерминированным.  
  
-   У выражения *computed_column_expression* нет доступа к системным данным или данным пользователя.  
  
Для индексирования требуется, чтобы любой вычисляемый столбец, содержащий выражение CLR, перед индексированием был детерминированным и помеченным как PERSISTED. Выражения определяемого пользователем типа данных CLR допускаются в определениях вычисляемых столбцов. Вычисляемые столбцы, которые имеют определяемый пользователем тип данных CLR, могут быть индексированы, если этот тип сопоставим. Дополнительные сведения об определяемых пользователем типах данных CLR см. в разделе [Определяемые пользователем типы данных CLR](../../relational-databases/clr-integration-database-objects-user-defined-types/clr-user-defined-types.md).  

#### <a name="cast-and-convert"></a>CAST и CONVERT

При указании в индексируемых вычисляемых столбцах [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] строковых литералов типа данных «дата» рекомендуется явно преобразовывать их в тип данных «дата» при помощи детерминированного стиля форматирования даты. Список детерминированных стилей форматирования даты см. в разделе [CAST и CONVERT](../../t-sql/functions/cast-and-convert-transact-sql.md). 

Дополнительные сведения см. в статье [Недетерминированное преобразование строк дат литералов в значения DATE](../../t-sql/data-types/nondeterministic-convert-date-literals.md).

#### <a name="compatibility-level"></a>Уровень совместимости

Неявное преобразование символьных данных не в Юникоде между различными параметрами сортировки считается недетерминированным, если уровень совместимости не установлен равным или меньшим 80.  

Если параметр уровня совместимости равен 90, создавать индексы на вычисляемых столбцах, содержащих эти выражения, нельзя. Это однако не относится к существующим вычисляемым столбцам, содержащим такие выражения из обновленной базы данных. Если используются индексированные вычисляемые столбцы, которые содержат неявные преобразования из строк в даты, то для предотвращения возможного повреждения индекса убедитесь, что параметры LANGUAGE и DATEFORMAT согласованы с базами данных и приложениями.

Уровень совместимости 90 соответствует SQL Server 2005.



## <a name="precision-requirements"></a>Требования к точности
  
 Выражение *computed_column_expression* должно быть точным. Выражение *computed_column_expression* является точным, если соблюдается одно или несколько следующих условий:  
  
-   Выражение не относится к типу данных **float** или **real** .  
-   В его определении не используется тип данных **float** или **real**. Например, в следующей инструкции столбец `y` имеет тип **int** и является детерминированным, но неточным.  
  
    ```sql  
    CREATE TABLE t2 (a int, b int, c int, x float,   
       y AS CASE x   
             WHEN 0 THEN a   
             WHEN 1 THEN b   
             ELSE c   
          END);  
    ```  
  
> [!NOTE]  
> Любое выражение, которое имеет тип данных **float** или **real**, считается неточным и не может быть ключом индекса; выражения, которые имеют тип **float** или **real**, могут использоваться в индексированном представлении, но не в качестве ключа. Это верно и для вычисляемых столбцов. Любая функция, выражение или определяемая пользователем функция считаются неточными, если содержат какие-либо выражения с типом данных **float** или **real**, включая логические выражения (сравнения).  
  
Свойство **IsPrecise** функции COLUMNPROPERTY определяет, является ли выражение *computed_column_expression* точным.  


## <a name="data-type-requirements"></a>Требования к типам данных
  
-   Выражение *computed_column_expression*, заданное для вычисляемого столбца, не может определять значения типов данных **text**, **ntext** или **image** .  
-   Вычисляемые столбцы, производные от типов данных **image**, **ntext**, **text**, **varchar(max)**, **nvarchar(max)**, **varbinary(max)** и **xml**, могут индексироваться, если тип данных вычисляемого столбца допускается в качестве ключевого столбца индекса.  
-   Вычисляемые столбцы, производные от типов данных **image**, **ntext** и **text**, могут быть неключевыми (включенными) столбцами некластеризованного индекса, если тип данных вычисляемого столбца является допустимым в качестве неключевого индексного столбца.  


## <a name="set-option-requirements"></a>Требования к параметру SET
  
-   Параметру уровня соединения ANSI_NULLS необходимо присвоить значение ON, если выполняется инструкция CREATE TABLE или ALTER TABLE, определяющая вычисляемый столбец. Функция [OBJECTPROPERTY](../../t-sql/functions/objectproperty-transact-sql.md) через свойство **IsAnsiNullsOn** сообщает, включен ли этот параметр.  
-   Соединение, для которого создается индекс, и все соединения, выполняющие инструкции INSERT, UPDATE или DELETE, которые изменяют значения в индексе, должны иметь шесть параметров инструкции SET в значении ON и один параметр в значении OFF. Оптимизатор пропускает индекс вычисляемого столбца для любой инструкции SELECT, выполняемой соединением, в котором эти параметры не имеют таких же значений.  
  
    -   Параметр NUMERIC_ROUNDABORT должен быть установлен в OFF, а следующие параметры должны быть установлены в ON:  
    -   ANSI_NULLS  
    -   ANSI_PADDING  
    -   ANSI_WARNINGS  
    -   ARITHABORT  
    -   CONCAT_NULL_YIELDS_NULL  
    -   QUOTED_IDENTIFIER  
  
> [!NOTE]
> Если уровень совместимости базы данных равен 90 или более, при установке параметра ANSI_WARNINGS в состояние ON параметр ARITHABORT также устанавливается в состояние ON.  
  
## <a name="creating-indexes-on-persisted-computed-columns"></a><a name="BKMK_persisted"></a>Создание индексов материализованных вычисляемых столбцов  

Иногда можно создать вычисляемый столбец, определенный с помощью выражения, которое является детерминированным, но неточным. Это можно сделать, если в инструкции CREATE TABLE или ALTER TABLE столбец помечен как PERSISTED.

Это значит, что компонент [!INCLUDE[ssDE](../../includes/ssde-md.md)] хранит вычисляемые значения в таблице и обновляет их при изменении любого столбца, от которого зависит вычисляемый столбец. Компонент [!INCLUDE[ssDE](../../includes/ssde-md.md)] использует эти сохраненные значения при создании индекса столбца и при появлении ссылки на этот столбец в запросе.

Этот параметр позволяет создавать индекс для вычисляемого столбца, если компонент [!INCLUDE[ssDE](../../includes/ssde-md.md)] не может точно определить, является ли функция, которая возвращает выражения вычисляемого столбца (в особенности функция CLR, созданная в [!INCLUDE[dnprdnshort](../../includes/dnprdnshort-md.md)]), и детерминированной, и точной.  


  
## <a name="related-content"></a>См. также  
 [COLUMNPROPERTY &#40;Transact-SQL&#41;](../../t-sql/functions/columnproperty-transact-sql.md)   
 [CREATE TABLE (Transact-SQL)](../../t-sql/statements/create-table-transact-sql.md)    
 [ALTER TABLE (Transact-SQL)](../../t-sql/statements/alter-table-transact-sql.md)
  
  
